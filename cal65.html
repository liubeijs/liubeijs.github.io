<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…­éšæœºäº”åŒºé—´æŠ¥ä»·å¾—åˆ†æ¨¡å‹è®¡ç®—å™¨</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            color: #333;
            background-color: #ffffff; /* å›ºå®šç™½è‰²èƒŒæ™¯ */
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333; /* å›ºå®šæ·±è‰²æ–‡å­— */
        }
        input, textarea, button {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #ffffff; /* è¾“å…¥æ¡†ç™½è‰²èƒŒæ™¯ */
            color: #333; /* è¾“å…¥æ–‡å­—æ·±è‰² */
        }
        input[type="number"] {
            width: 100px;
        }
        textarea {
            width: 100%;
            height: 120px;
            resize: vertical;
        }
        button {
            background-color: #3498db;
            color: white;
            cursor: pointer;
            border: none;
            padding: 10px 15px;
            margin-right: 10px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #2980b9;
        }
        #calculation-steps {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            white-space: pre-wrap;
            border: 1px solid #ddd; /* æ·»åŠ è¾¹æ¡† */
        }
        #result-range {
            margin-top: 20px;
            padding: 15px;
            background-color: #e8f4f8;
            border-left: 5px solid #3498db;
            color: #333;
            white-space: pre-wrap; /* æ·»åŠ è¿™ä¸€è¡Œ */
        }
        .error {
            color: #e74c3c;
            font-size: 0.9em;
        }
        .random-weights {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        .weight-input {
            display: flex;
            align-items: center;
        }
        .weight-input label {
            margin-right: 5px;
            width: 30px;
        }
        .weight-input span {
            margin-left: 2px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            background-color: #ffffff; /* è¡¨æ ¼ç™½è‰²èƒŒæ™¯ */
        }
        th {
            background-color: #f2f2f2;
        }
        .example {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
        .fixed-button {
            position: fixed;
            right: 300px;
            bottom: 20px;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .price-distribution-table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
        }
        .price-distribution-table th,
        .price-distribution-table td {
            padding: 8px;
            text-align: center;
            border: 1px solid #ddd;
        }
        .price-distribution-table th {
            background-color: #f5f5f5;
        }
        .price-distribution-table tr:hover {
            background-color: #f8f9fa;
        }

        /* åœ¨ç°æœ‰CSSä¸­æ·»åŠ æŠ˜å æ ·å¼ */
        .collapsible-section {
            margin: 20px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }

        .collapsible-header {
            padding: 15px;
            background-color: #f0f0f0;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            border-radius: 5px 5px 0 0;
        }

        .collapsible-header:hover {
            background-color: #e0e0e0;
        }

        .collapsible-content {
            padding: 15px;
            border-top: 1px solid #ddd;
        }

        .collapse-icon {
            transition: transform 0.3s ease;
            font-size: 12px;
        }

        .collapse-icon.expanded {
            transform: rotate(90deg);
        }
    </style>
</head>
<body>
    <h1>å…­éšæœºäº”åŒºé—´æŠ¥ä»·å¾—åˆ†æ¨¡å‹è®¡ç®—å™¨</h1>
    
    <div class="form-group">
        <label for="max-price">æœ€é«˜é™ä»· (Y):</label>
        <input type="number" id="max-price" value="100" min="0" step="0.01">
    </div>
    
    <div class="form-group">
        <label for="bids-input">æŠ•æ ‡å•ä½æŠ¥ä»· (P<sub>i</sub>):</label>
        <textarea id="bids-input" placeholder="æ¯è¡Œè¾“å…¥ä¸€ä¸ªæŠ¥ä»·ï¼Œä¾‹å¦‚ï¼š
99
98
95
94
92
90
88
85
83
81
80.5
80"></textarea>
        <div class="example">æç¤ºï¼šæ¯è¡Œè¾“å…¥ä¸€ä¸ªæŠ¥ä»·ï¼Œæ”¯æŒå°æ•°ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è¿‡æ»¤æ— æ•ˆè¾“å…¥</div>
    </div>
    
    <div class="form-group">
        <label for="c1">æ¯”ä¾‹ç³»æ•° (C<sub>1</sub>):</label>
        <input type="number" id="c1" value="0.5" min="0.4" max="0.6" step="0.01">
        <span class="error" id="c1-error"></span>
        <small>(å–å€¼èŒƒå›´: 0.4 â‰¤ C<sub>1</sub> â‰¤ 0.6)</small>
    </div>
    
    <div class="form-group">
        <label for="r">ä¸‹æµ®ç³»æ•° (r):</label>
        <input type="number" id="r" value="5" min="2" max="10" step="0.1">
        <span class="error" id="r-error"></span>
        <small>(å·¥ç¨‹æ–½å·¥ç±»é»˜è®¤: 2% â‰¤ r â‰¤ 10%)</small>
    </div>
    
    <div class="form-group">
        <label>æƒé‡ç³»æ•°:</label>
        <div class="random-weights">
            <div class="weight-input">
                <label>a:</label>
                <input type="number" id="a" min="0" max="100" step="1" value="40">
                <span>%</span>
            </div>
            <div class="weight-input">
                <label>b:</label>
                <input type="number" id="b" min="0" max="100" step="1" value="15">
                <span>%</span>
            </div>
            <div class="weight-input">
                <label>c:</label>
                <input type="number" id="c" min="0" max="100" step="1" value="15">
                <span>%</span>
            </div>
            <div class="weight-input">
                <label>d:</label>
                <input type="number" id="d" min="0" max="100" step="1" value="30">
                <span>%</span>
            </div>
            <div class="weight-input">
                <label>e:</label>
                <input type="number" id="e" min="0" max="100" step="1" value="35">
                <span>%</span>
            </div>
            <div class="weight-input">
                <label>f:</label>
                <input type="number" id="f" min="0" max="100" step="1" value="30">
                <span>%</span>
            </div>
            <div class="weight-input">
                <label>g:</label>
                <input type="number" id="g" min="0" max="100" step="1" value="35">
                <span>%</span>
            </div>
        </div>
        <button type="button" id="randomize-weights">éšæœºç”Ÿæˆæƒé‡</button>
        <small>(çº¦æŸæ¡ä»¶: a + b + c + d = 100%, e + f + g = 100%)</small>
        <div id="weights-display" style="margin-top: 15px;"></div>
    </div>
    

    <button type="button" id="calculate" class="fixed-button" style="right: 300px;">è®¡ç®—è¯„æ ‡åŸºå‡†å€¼</button>
    <button type="button" id="scatter-plot" class="fixed-button" style="right: 120px;">æŠ¥ä»·æ•£åˆ—å›¾</button>
    
    <div class="collapsible-section">
        <div class="collapsible-header" onclick="toggleCollapse('calculation-steps-content')">
            <span>ğŸ“Š è¯„æ ‡åŸºå‡†å€¼è®¡ç®—è¿‡ç¨‹</span>
            <span class="collapse-icon" id="calculation-steps-icon">â–¶</span>
        </div>
        <div id="calculation-steps-content" class="collapsible-content" style="display: none;">
            <div id="calculation-steps"></div>
            <div id="result-range"></div>            
        </div>
    </div>

    <div id="price-distribution"></div>
    
    <!-- å›¾è¡¨å®¹å™¨ -->
    <div style="margin-top: 20px; padding: 15px; background-color: #fff; height: 400px;">
        <canvas id="distributionChart"></canvas>
    </div>
    
    <!-- æ•£åˆ—å›¾å®¹å™¨ -->
    <div id="scatter-chart-container" style="margin-top: 20px; padding: 15px; background-color: #fff; height: 400px; display: none;">
        <canvas id="scatterChart"></canvas>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // æŠ¥ä»·æ•£åˆ—å›¾æŒ‰é’®
            document.getElementById('scatter-plot').addEventListener('click', generateScatterPlot);


            // è·å–URLå‚æ•°
            const urlParams = new URLSearchParams(window.location.search);
            const maxPriceParam = urlParams.get('maxPrice');
            const bidsParam = urlParams.get('bids');
            
            // è®¾ç½®æœ€é«˜é™ä»·
            if (maxPriceParam) {
                document.getElementById('max-price').value = parseFloat(maxPriceParam);
            }
            
            // è®¾ç½®æŠ•æ ‡æŠ¥ä»·
            if (bidsParam) {
                // è§£ææŠ¥ä»·å­—ç¬¦ä¸²ï¼Œæ ¼å¼ä¸ºé€—å·åˆ†éš”çš„æ•°å­—
                const bids = bidsParam.split(',').map(bid => bid.trim());
                document.getElementById('bids-input').value = bids.join('\n');
            }

            // è®¾ç½®æƒé‡å‚æ•° a-g
            const weightParams = ['a', 'b', 'c', 'd', 'e', 'f', 'g'];
            weightParams.forEach(param => {
                const value = urlParams.get(param);
                if (value) {
                    document.getElementById(param).value = value;
                }
            });

            // è®¾ç½®æ¯”ä¾‹ç³»æ•° C1
            const c1Param = urlParams.get('C1');
            if (c1Param) {
                document.getElementById('c1').value = c1Param;
            }

            // è®¾ç½®ä¸‹æµ®ç³»æ•° r
            const rParam = urlParams.get('r');
            if (rParam) {
                document.getElementById('r').value = rParam;
            }

            // éšæœºç”Ÿæˆæƒé‡æŒ‰é’®
            document.getElementById('randomize-weights').addEventListener('click', randomizeWeights);
            
            // è®¡ç®—æŒ‰é’®
            document.getElementById('calculate').addEventListener('click', calculate);
            
            // éªŒè¯æ¯”ä¾‹ç³»æ•°è¾“å…¥
            document.getElementById('c1').addEventListener('change', function() {
                const c1 = parseFloat(this.value);
                const errorElement = document.getElementById('c1-error');
                if (c1 < 0.4 || c1 > 0.6) {
                    errorElement.textContent = 'æ¯”ä¾‹ç³»æ•°å¿…é¡»åœ¨0.4åˆ°0.6ä¹‹é—´';
                } else {
                    errorElement.textContent = '';
                }
            });
            
            // éªŒè¯ä¸‹æµ®ç³»æ•°è¾“å…¥
            document.getElementById('r').addEventListener('change', function() {
                const r = parseFloat(this.value);
                const errorElement = document.getElementById('r-error');
                if (r < 2 || r > 10) {
                    errorElement.textContent = 'ä¸‹æµ®ç³»æ•°å¿…é¡»åœ¨2%åˆ°10%ä¹‹é—´';
                } else {
                    errorElement.textContent = '';
                }
            });
        });
        
        function randomizeWeights() {
            // ç”Ÿæˆç¬¦åˆçº¦æŸæ¡ä»¶çš„éšæœºæƒé‡ï¼ˆç™¾åˆ†æ¯”å½¢å¼ï¼‰
            const a = Math.round(Math.random() * 15 + 30); // 30%-45%
            const b = Math.round(Math.random() * 15 + 5);  // 5%-20%
            const c = Math.round(Math.random() * 15 + 5);  // 5%-20%
            const d = 100 - a - b - c;  // å‰©ä½™éƒ¨åˆ†
            
            const e = Math.round(Math.random() * 15 + 35); // 35%-50%
            const f = Math.round(Math.random() * 25 + 5);  // 5%-30%
            const g = 100 - e - f;  // å‰©ä½™éƒ¨åˆ†
            
            // è®¾ç½®è¾“å…¥æ¡†çš„å€¼
            document.getElementById('a').value = a;
            document.getElementById('b').value = b;
            document.getElementById('c').value = c;
            document.getElementById('d').value = d;
            document.getElementById('e').value = e;
            document.getElementById('f').value = f;
            document.getElementById('g').value = g;
        }

        function calculate() {
            // è·å–è¾“å…¥å€¼
            const maxPrice = parseFloat(document.getElementById('max-price').value);
            const c1 = parseFloat(document.getElementById('c1').value);
            
            // è·å–æ‰€æœ‰æŠ¥ä»·
            const bidsText = document.getElementById('bids-input').value;
            const bidLines = bidsText.split('\n');
            let bids = [];
            
            bidLines.forEach(line => {
                const trimmed = line.trim();
                if (trimmed) {
                    const value = parseFloat(trimmed);
                    if (!isNaN(value)) {
                        bids.push(value);
                    }
                }
            });
            
            if (bids.length === 0) {
                alert('è¯·è¾“å…¥è‡³å°‘ä¸€ä¸ªæœ‰æ•ˆæŠ¥ä»·');
                return;
            }
                        
            // è·å–æƒé‡å€¼ï¼ˆéœ€è¦è½¬æ¢ä¸ºå°æ•°ï¼‰
            const a = parseFloat(document.getElementById('a').value) / 100;
            const b = parseFloat(document.getElementById('b').value) / 100;
            const c = parseFloat(document.getElementById('c').value) / 100;
            const d = parseFloat(document.getElementById('d').value) / 100;
            const e = parseFloat(document.getElementById('e').value) / 100;
            const f = parseFloat(document.getElementById('f').value) / 100;
            const g = parseFloat(document.getElementById('g').value) / 100;
            
            // è·å–ä¸‹æµ®ç³»æ•°ï¼ˆéœ€è¦è½¬æ¢ä¸ºå°æ•°ï¼‰
            const r = parseFloat(document.getElementById('r').value) / 100;
            
            // éªŒè¯çº¦æŸæ¡ä»¶
            const sum1 = Math.round((a + b + c + d) * 100);
            const sum2 = Math.round((e + f + g) * 100);
            
            if (sum1 !== 100) {
                alert('é”™è¯¯ï¼ša + b + c + d çš„å’Œå¿…é¡»ç­‰äº100%');
                return;
            }
            
            if (sum2 !== 100) {
                alert('é”™è¯¯ï¼še + f + g çš„å’Œå¿…é¡»ç­‰äº100%');
                return;
            }
            
            // è®¡ç®—æ­¥éª¤
            let steps = "=== è¯„æ ‡åŸºå‡†å€¼è®¡ç®—è¿‡ç¨‹ ===\n\n";
            
            steps += `å…±æœ‰ ${bids.length} å®¶æŠ•æ ‡å•ä½\n\n`;

            // 1. è·å–æœ‰æ•ˆæŠ¥ä»·
            steps += "1. è·å–æœ‰æ•ˆæŠ¥ä»·:\n";
            steps += `- æœ€é«˜é™ä»· (Y): ${maxPrice}\n`;
            steps += `- æŠ•æ ‡æŠ¥ä»·: ${bids.join(', ')}\n`;
            
            const minValidPrice = maxPrice * 0.8;
            const validBids = bids.filter(bid => bid >= minValidPrice);
            const invalidBids = bids.filter(bid => bid < minValidPrice);
            
            steps += `- æœ‰æ•ˆæŠ¥ä»·éœ€ â‰¥ ${minValidPrice} (æœ€é«˜é™ä»·çš„80%)\n`;
            steps += `- å‰”é™¤çš„æŠ¥ä»·: ${invalidBids.length > 0 ? invalidBids.join(', ') : 'æ— '}\n`;
            steps += `- å‰©ä½™æœ‰æ•ˆæŠ¥ä»·: ${validBids.join(', ')}\n`;
            steps += `- æœ‰æ•ˆæŠ¥ä»·å•ä½æ•° (W): ${validBids.length}\n\n`;
            
            // 2. å‰”é™¤æå€¼
            steps += "2. å‰”é™¤æå€¼:\n";
            let bidsForCalculation = [...validBids].sort((a, b) => a - b);
            let removedBids = [];
            
            if (validBids.length >= 10) {
                // å»æ‰æœ€ä½10%å’Œæœ€é«˜15%
                const removeLow = Math.round(validBids.length * 0.1);
                const removeHigh = Math.round(validBids.length * 0.15);
                
                removedBids = [
                    ...bidsForCalculation.slice(0, removeLow),
                    ...bidsForCalculation.slice(-removeHigh)
                ];
                
                bidsForCalculation = bidsForCalculation.slice(removeLow, -removeHigh);
                
                steps += `- W â‰¥ 10ï¼Œå»æ‰æœ€ä½10%(${removeLow}å®¶)å’Œæœ€é«˜15%(${removeHigh}å®¶)çš„æŠ¥ä»·\n`;
                steps += `- å‰”é™¤çš„æŠ¥ä»·: ${removedBids.join(', ')}\n`;
            } else {
                steps += "- W < 10ï¼Œä¸å»æ‰ä»»ä½•æŠ¥ä»·\n";
            }
            
            steps += `- çº³å…¥åŸºå‡†ä»·è®¡ç®—çš„æŠ¥ä»·: ${bidsForCalculation.join(', ')}\n`;
            steps += `- çº³å…¥è®¡ç®—çš„å•ä½æ•° (N): ${bidsForCalculation.length}\n\n`;
            
            // 3. è®¡ç®—å¹³å‡ä»· C
            steps += "3. è®¡ç®—å¹³å‡ä»· (C):\n";
            
            if (bidsForCalculation.length < 5) {
                steps += "- N < 5ï¼Œä½¿ç”¨ç®€åŒ–å…¬å¼: C = eÎ¼ + fM + gG\n";
            } else {
                steps += "- N â‰¥ 5ï¼Œä½¿ç”¨å®Œæ•´å…¬å¼: C = aÎ¼ + bM + c((Qâ‚+Qâ‚ƒ)/2) + dG\n";
            }
            
            // è®¡ç®—ç»Ÿè®¡é‡
            const Î¼ = bidsForCalculation.reduce((sum, bid) => sum + bid, 0) / bidsForCalculation.length;
            const Î¼Ratio = (1-Î¼/maxPrice)*100;
            steps += `- ç®—æœ¯å¹³å‡æ•° (Î¼): ${Î¼.toFixed(2)} [${Î¼Ratio.toFixed(2)}%]\n`;
            
            // ä¸­ä½æ•°
            const sortedBids = [...bidsForCalculation].sort((a, b) => a - b);
            let M;
            if (sortedBids.length % 2 === 1) {
                M = sortedBids[Math.floor(sortedBids.length / 2)];
            } else {
                M = (sortedBids[sortedBids.length / 2 - 1] + sortedBids[sortedBids.length / 2]) / 2;
            }
            steps += `- ä¸­ä½æ•° (M): ${M.toFixed(2)}\n`;
            
            // å››åˆ†ä½æ•°
            let Q1, Q3;
            if (bidsForCalculation.length >= 5) {
                const Î¸ = 0.25 * (sortedBids.length + 1);
                const Î³ = 0.75 * (sortedBids.length + 1);
                
                const i = Math.floor(Î¸);
                const iPrime = Math.floor(Î³);
                
                Q1 = sortedBids[i - 1] + (Î¸ - i) * (sortedBids[i] - sortedBids[i - 1]);
                Q3 = sortedBids[iPrime - 1] + (Î³ - iPrime) * (sortedBids[iPrime] - sortedBids[iPrime - 1]);
                
                steps += `- ç¬¬ä¸€å››åˆ†ä½æ•° (Qâ‚): ${Q1.toFixed(2)}\n`;
                steps += `- ç¬¬ä¸‰å››åˆ†ä½æ•° (Qâ‚ƒ): ${Q3.toFixed(2)}\n`;
                steps += `- (Qâ‚ + Qâ‚ƒ)/2: ${((Q1 + Q3) / 2).toFixed(2)}\n`;
            }
            
            // å‡ ä½•å¹³å‡æ•°è®¡ç®—ï¼ˆä½¿ç”¨å¯¹æ•°æ³•ï¼‰
            const logSum = sortedBids.reduce((sum, bid) => sum + Math.log(bid), 0);
            const G = Math.exp(logSum / sortedBids.length);
            steps += `- å‡ ä½•å¹³å‡æ•° (G): ${G.toFixed(2)}\n`;

            if (bidsForCalculation.length >= 5) {

                steps += "\n- è·å–æƒé‡å‚æ•° (N >= 5):\n";
                steps += `  a = ${a.toFixed(4)}\n`;
                steps += `  b = ${b.toFixed(4)}\n`;
                steps += `  c = ${c.toFixed(4)}\n`;
                steps += `  d = ${d.toFixed(4)}\n`;
                
                // è®¡ç®—C
                const C = a * Î¼ + b * M + c * (Q1 + Q3) / 2 + d * G;
                steps += `\n- å¹³å‡ä»· C = aÎ¼ + bM + c((Qâ‚+Qâ‚ƒ)/2) + dG\n`;
                steps += `            = ${a.toFixed(4)}Ã—${Î¼.toFixed(2)} + ${b.toFixed(4)}Ã—${M.toFixed(2)} + ${c.toFixed(4)}Ã—${((Q1 + Q3) / 2).toFixed(2)} + ${d.toFixed(4)}Ã—${G.toFixed(2)}\n`;
                steps += `            = ${(a * Î¼).toFixed(2)} + ${(b * M).toFixed(2)} + ${(c * (Q1 + Q3) / 2).toFixed(2)} + ${(d * G).toFixed(2)}\n`;
                steps += `            = ${C.toFixed(2)}\n`;
            } else {
                
                steps += "\n- è·å–æƒé‡å‚æ•° (N < 5):\n";
                steps += `  e = ${e.toFixed(4)}\n`;
                steps += `  f = ${f.toFixed(4)}\n`;
                steps += `  g = ${g.toFixed(4)}\n`;
                
                // è®¡ç®—C
                const C = e * Î¼ + f * M + g * G;
                steps += `\n- å¹³å‡ä»· C = eÎ¼ + fM + gG\n`;
                steps += `            = ${e.toFixed(4)}Ã—${Î¼.toFixed(2)} + ${f.toFixed(4)}Ã—${M.toFixed(2)} + ${g.toFixed(4)}Ã—${G.toFixed(2)}\n`;
                steps += `            = ${(e * Î¼).toFixed(2)} + ${(f * M).toFixed(2)} + ${(g * G).toFixed(2)}\n`;
                steps += `            = ${C.toFixed(2)}\n`;
            }
            
            const C = bidsForCalculation.length >= 5 ? 
                a * Î¼ + b * M + c * (Q1 + Q3) / 2 + d * G :
                e * Î¼ + f * M + g * G;
            
            // 4. è®¡ç®—è¯„æ ‡åŸºå‡†ä»· T
            steps += "\n4. è®¡ç®—è¯„æ ‡åŸºå‡†ä»· (T):\n";
            steps += `- å…¬å¼: T = [Y Ã— Câ‚ + C Ã— (1 - Câ‚)] Ã— (1 - r)\n`;
            steps += `         = [${maxPrice} Ã— ${c1} + ${C.toFixed(2)} Ã— ${(1 - c1).toFixed(2)}] Ã— ${(1 - r).toFixed(3)}\n`;
            
            const part1 = maxPrice * c1;
            const part2 = C * (1 - c1);
            steps += `         = [${part1.toFixed(2)} + ${part2.toFixed(2)}] Ã— ${(1 - r).toFixed(3)}\n`;
            
            const beforeR = part1 + part2;
            const T = beforeR * (1 - r);
            steps += `         = ${beforeR.toFixed(2)} Ã— ${(1 - r).toFixed(3)}\n`;
            steps += `         = ${T.toFixed(2)}\n\n`;

            const ratio = (1-T/maxPrice)*100;
            steps += `=== æœ€ç»ˆè¯„æ ‡åŸºå‡†å€¼ (T) ===\n${T.toFixed(2)} [${ratio.toFixed(2)}%]`;
            
            // æ˜¾ç¤ºè®¡ç®—æ­¥éª¤
            document.getElementById('calculation-steps').textContent = steps;
            
            // è®¡ç®—å¹¶æ˜¾ç¤ºå–å€¼èŒƒå›´
            let rangeText = "å·¥ç¨‹æ–½å·¥ç±»é¡¹ç›®è¯„æ ‡åŸºå‡†å€¼å–å€¼èŒƒå›´:\n\n";
            
            // è®¡ç®—C1å’Œrçš„æç«¯å€¼ç»„åˆ
            const C_min = 0.4, C_max = 0.6;
            const r_min = 0.02, r_max = 0.1;
            
            // è®¡ç®—å››ç§æç«¯ç»„åˆ
            const T1 = (maxPrice * C_min + C * (1 - C_min)) * (1 - r_min);
            const T2 = (maxPrice * C_min + C * (1 - C_min)) * (1 - r_max);
            const T3 = (maxPrice * C_max + C * (1 - C_max)) * (1 - r_min);
            const T4 = (maxPrice * C_max + C * (1 - C_max)) * (1 - r_max);
            
            rangeText += `1. å½“ Câ‚å–æœ€å°å€¼(0.4), rå–æœ€å°å€¼(2%)æ—¶ï¼šT = ${T1.toFixed(2)}\n`;
            rangeText += `2. å½“ Câ‚å–æœ€å°å€¼(0.4), rå–æœ€å¤§å€¼(10%)æ—¶ï¼šT = ${T2.toFixed(2)}\n`;
            rangeText += `3. å½“ Câ‚å–æœ€å¤§å€¼(0.6), rå–æœ€å°å€¼(2%)æ—¶ï¼šT = ${T3.toFixed(2)}\n`;
            rangeText += `4. å½“ Câ‚å–æœ€å¤§å€¼(0.6), rå–æœ€å¤§å€¼(10%)æ—¶ï¼šT = ${T4.toFixed(2)}\n`;
            
            const minT = Math.min(T1, T2, T3, T4);
            const maxT = Math.max(T1, T2, T3, T4);
            const minT_ratio = (1-minT/maxPrice)*100;
            const maxT_ratio = (1-maxT/maxPrice)*100;
            rangeText += `\nå› æ­¤ï¼Œè¯„æ ‡åŸºå‡†å€¼å¯èƒ½çš„å–å€¼èŒƒå›´ä¸º:\n${minT.toFixed(2)} åˆ° ${maxT.toFixed(2)}`;
            rangeText += `\nä¸‹æµ®èŒƒå›´ä¸º:  ${maxT_ratio.toFixed(2)}% åˆ° ${minT_ratio.toFixed(2)}%`;

            document.getElementById('result-range').textContent = rangeText;
        

    // æ·»åŠ æŠ¥ä»·åˆ†å¸ƒç»Ÿè®¡
    const priceDistribution = document.getElementById('price-distribution');
    
    // åˆ›å»ºåˆ†å¸ƒåŒºé—´æ•°ç»„ï¼ˆ1%åˆ°20%ï¼Œæ¯1%ä¸€ä¸ªåŒºé—´ï¼‰
    const intervals = Array.from({length: 20}, (_, i) => ({
        min: i + 1,
        max: i + 2,
        count: 0
    }));
    
    // ç»Ÿè®¡æ¯ä¸ªæŠ¥ä»·çš„ä¸‹æµ®ç‡åˆ†å¸ƒ
    validBids.forEach(bid => {
        const ratio = ((maxPrice - bid) / maxPrice * 100).toFixed(2);
        const ratioNum = parseFloat(ratio);
        
        for (let interval of intervals) {
            if (ratioNum >= interval.min && ratioNum < interval.max) {
                interval.count++;
                break;
            }
        }
    });
    
    // ç”Ÿæˆè¡¨æ ¼HTML
    let tableHtml = `
        <h3 style="margin-top: 20px; color: #2c3e50;">æŠ¥ä»·ä¸‹æµ®ç‡åˆ†å¸ƒ</h3>
        <table class="price-distribution-table">
            <thead>
                <tr>
                    <th>ä¸‹æµ®åŒºé—´</th>
                    <th>æ•°é‡</th>
                    <th>å æ¯”</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    // åªæ˜¾ç¤ºæœ‰æ•°æ®çš„åŒºé—´
    intervals.forEach(interval => {
        if (interval.count > 0) {
            const percentage = (interval.count / validBids.length * 100).toFixed(2);
            tableHtml += `
                <tr>
                    <td>${interval.min}% - ${interval.max}%</td>
                    <td>${interval.count}</td>
                    <td>${percentage}%</td>
                </tr>
            `;
        }
    });
    
    tableHtml += `
            </tbody>
        </table>
    `;
    
    priceDistribution.innerHTML = tableHtml;


            // ç”Ÿæˆå¹¶ç»˜åˆ¶åˆ†å¸ƒå›¾
            const samples = [];
            // æ¨¡æ‹Ÿ80000æ¬¡éšæœºç»„åˆ
            for (let i = 0; i < 80000; i++) {
                // éšæœºç”Ÿæˆå‚æ•°
                const randomC1 = Math.random() * (0.6 - 0.4) + 0.4;
                const randomR = Math.random() * (0.1 - 0.02) + 0.02;
                
                // è®¡ç®—è¯¥ç»„åˆä¸‹çš„è¯„æ ‡åŸºå‡†å€¼
                const randomT = (maxPrice * randomC1 + C * (1 - randomC1)) * (1 - randomR);
                const randomT_ratio = (1-randomT/maxPrice)*100;
                samples.push(randomT_ratio);
            }

            // æ¸…é™¤æ—§å›¾è¡¨
            const chartCanvas = document.getElementById('distributionChart');
            if (window.myChart) {
                window.myChart.destroy();
            }

            // è®¡ç®—æ•°æ®åˆ†å¸ƒ
            const binCount = 40;
            const min = Math.min(...samples);
            const max = Math.max(...samples);
            const binWidth = (max - min) / binCount;
            const bins = new Array(binCount).fill(0);
            
            samples.forEach(value => {
                const binIndex = Math.min(
                    Math.floor((value - min) / binWidth),
                    binCount - 1
                );
                bins[binIndex]++;
            });

            // ç”Ÿæˆæ ‡ç­¾
            const labels = bins.map((_, i) => 
                `${(min + i * binWidth).toFixed(2)}%`
            );

            // åˆ›å»ºå›¾è¡¨
            window.myChart = new Chart(chartCanvas, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'é¢‘æ¬¡åˆ†å¸ƒ',
                        data: bins,
                        backgroundColor: 'rgba(52, 152, 219, 0.5)',
                        borderColor: 'rgba(52, 152, 219, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'å‡ºç°æ¬¡æ•°'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'è¯„æ ‡åŸºå‡†å€¼'
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'è¯„æ ‡åŸºå‡†å€¼åˆ†å¸ƒæƒ…å†µï¼ˆæ¨¡æ‹Ÿ80000æ¬¡ï¼‰',
                            font: {
                                size: 16
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `å‡ºç°æ¬¡æ•°: ${context.raw}`;
                                }
                            }
                        }
                    }
                }
            });
        }

    </script>

    <script>
        // ç”ŸæˆæŠ¥ä»·æ•£åˆ—å›¾
        function generateScatterPlot() {
            // è·å–æœ€é«˜é™ä»·å’ŒæŠ¥ä»·
            const maxPrice = parseFloat(document.getElementById('max-price').value);
            const bidsText = document.getElementById('bids-input').value;
            const bidLines = bidsText.split('\n');
            let bids = [];
            
            // è§£ææœ‰æ•ˆæŠ¥ä»·
            bidLines.forEach(line => {
                const trimmed = line.trim();
                if (trimmed) {
                    const value = parseFloat(trimmed);
                    if (!isNaN(value)) {
                        bids.push(value);
                    }
                }
            });
            
            if (bids.length === 0) {
                alert('è¯·è¾“å…¥è‡³å°‘ä¸€ä¸ªæœ‰æ•ˆæŠ¥ä»·');
                return;
            }
            
            // è®¡ç®—æ¯ä¸ªæŠ¥ä»·çš„ä¸‹æµ®ç‡
            const bidRatios = bids.map(bid => {
                const ratio = (1 - bid / maxPrice) * 100;
                return parseFloat(ratio.toFixed(2));
            });
            
            // åˆ›å»ºåŒºé—´ï¼ˆ5.0%-5.99%, 6.0%-6.99%, ç­‰ï¼‰
            const minRatio = Math.floor(Math.min(...bidRatios));
            const maxRatio = Math.ceil(Math.max(...bidRatios));
            
            // åˆ›å»ºåŒºé—´æ•°ç»„
            const intervals = [];
            for (let i = minRatio; i <= maxRatio; i++) {
                intervals.push({
                    min: i,
                    max: i + 0.99,
                    label: `${i}.0%-${i}.99%`,
                    count: 0,
                    bids: []
                });
            }
            
            // ç»Ÿè®¡æ¯ä¸ªåŒºé—´çš„æŠ¥ä»·æ•°é‡
            bidRatios.forEach((ratio, index) => {
                const intervalIndex = Math.floor(ratio) - minRatio;
                if (intervalIndex >= 0 && intervalIndex < intervals.length) {
                    intervals[intervalIndex].count++;
                    intervals[intervalIndex].bids.push({
                        price: bids[index],
                        ratio: ratio
                    });
                }
            });
            
            // æ¸…é™¤æ—§å›¾è¡¨
            const chartCanvas = document.getElementById('scatterChart');
            if (window.scatterChart && typeof window.scatterChart.destroy === 'function') {
                window.scatterChart.destroy();
            }
            
            // å‡†å¤‡æ•£åˆ—å›¾æ•°æ®
            const datasets = [];
            const colors = [
                'rgba(255, 99, 132, 0.7)',   // çº¢è‰²
                'rgba(54, 162, 235, 0.7)',   // è“è‰²
                'rgba(255, 206, 86, 0.7)',   // é»„è‰²
                'rgba(75, 192, 192, 0.7)',   // é’è‰²
                'rgba(153, 102, 255, 0.7)',  // ç´«è‰²
                'rgba(255, 159, 64, 0.7)',   // æ©™è‰²
                'rgba(199, 199, 199, 0.7)',  // ç°è‰²
                'rgba(83, 102, 255, 0.7)',   // é›è“è‰²
                'rgba(255, 99, 255, 0.7)',   // ç²‰è‰²
                'rgba(99, 255, 132, 0.7)'    // æµ…ç»¿è‰²
            ];
            
            // ä¸ºæ¯ä¸ªåŒºé—´åˆ›å»ºä¸€ä¸ªæ•°æ®é›†
            intervals.forEach((interval, index) => {
                if (interval.count > 0) {
                    const colorIndex = index % colors.length;
                    // ä¿®æ”¹æ•£åˆ—å›¾æ•°æ®ç‚¹çš„åæ ‡è®¡ç®—
                    const data = interval.bids.map(bid => {
                        const integerPart = Math.floor(bid.ratio); // æ•´æ•°éƒ¨åˆ†ä½œä¸ºxè½´
                        const decimalPart = bid.ratio - integerPart; // å°æ•°éƒ¨åˆ†ä½œä¸ºyè½´
                        return {
                            x: integerPart,
                            y: decimalPart,
                            price: bid.price,
                            fullRatio: bid.ratio
                        };
                    });
                    
                    datasets.push({
                        label: interval.label,
                        data: data,
                        backgroundColor: colors[colorIndex],
                        borderColor: colors[colorIndex].replace('0.7', '1'),
                        borderWidth: 1,
                        pointRadius: 6,
                        pointHoverRadius: 8
                    });
                }
            });
            
            // æ˜¾ç¤ºæ•£åˆ—å›¾å®¹å™¨
            document.getElementById('scatter-chart-container').style.display = 'block';
            
            // åˆ›å»ºæ•£åˆ—å›¾
            window.scatterChart = new Chart(chartCanvas, {
                type: 'scatter',
                data: {
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            title: {
                                display: true,
                                text: 'ä¸‹æµ®ç‡æ•´æ•°éƒ¨åˆ† (%)'
                            },
                            min: Math.floor(Math.min(...bidRatios)) - 0.5,
                            max: Math.floor(Math.max(...bidRatios)) + 0.5,
                            ticks: {
                                stepSize: 1
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'ä¸‹æµ®ç‡å°æ•°éƒ¨åˆ†'
                            },
                            min: 0,
                            max: 1,
                            ticks: {
                                stepSize: 0.1
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'æŠ¥ä»·ä¸‹æµ®ç‡æ•£åˆ—åˆ†å¸ƒå›¾',
                            font: {
                                size: 16
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const point = context.raw;
                                    return [
                                        `æŠ¥ä»·: ${point.price}`,
                                        `å®Œæ•´ä¸‹æµ®ç‡: ${point.fullRatio.toFixed(2)}%`,
                                        `æ•´æ•°éƒ¨åˆ†: ${point.x}%`,
                                        `å°æ•°éƒ¨åˆ†: ${point.y.toFixed(3)}`
                                    ];
                                }
                            }
                        },
                        legend: {
                            position: 'top',
                            labels: {
                                boxWidth: 12,
                                generateLabels: function(chart) {
                                    const originalLabels = Chart.defaults.plugins.legend.labels.generateLabels(chart);
                                    return originalLabels.map(label => {
                                        const dataset = chart.data.datasets[label.datasetIndex];
                                        label.text = `${dataset.label} (${dataset.data.length}ä¸ª)`;
                                        return label;
                                    });
                                }
                            }
                        }
                    }
                }
            });
        }

        // æ·»åŠ æŠ˜å åˆ‡æ¢å‡½æ•°
        function toggleCollapse(contentId) {
            const content = document.getElementById(contentId);
            const icon = document.getElementById('calculation-steps-icon');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.textContent = 'â–¼';
                icon.classList.add('expanded');
            } else {
                content.style.display = 'none';
                icon.textContent = 'â–¶';
                icon.classList.remove('expanded');
            }
        }

    </script>
    
</body>
</html>

