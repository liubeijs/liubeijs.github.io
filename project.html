<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>项目投标信息</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.3.1/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .company-link {
            color: #666;
            margin-left: 5px;
            cursor: pointer;
        }
        .company-link:hover {
            color: #007bff;
        }
        .sort-btn {
            font-size: 0.8em;
            margin-left: 5px;
            padding: 2px 5px;
        }
        .chart-container {
            position: relative;
            height: 400px;
            margin-top: 20px;
        }
        .button-group {
            display: flex;
            gap: 10px; /* 按钮之间的间距 */
        }
        .btn-primary {
            background-color: #5dc3e5; /* 淡蓝色 */
            border-color: #5dc3e5;
            color: #fff;
            padding: 5px 15px; /* 调整按钮的内边距 */
            font-size: 0.9em; /* 调整字体大小 */
        }
        .btn-primary:hover {
            background-color: #0eb0f0; /* 更深的蓝色用于悬停效果 */
            border-color: #0eb0f0;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h2 id="projectTitle" class="mb-4">项目信息加载中...</h2>
        
        <!-- 项目基本信息 -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                项目基本信息
                <!-- 使用flexbox布局按钮 -->
                <div class="button-group">
                    <button id="sunshineRoomButton" class="btn btn-primary">省中心阳光房</button>
                    <button id="analysisButton" class="btn btn-primary">六随机基准值分析</button>
                </div>
            </div>
            <div class="card-body">
                <table class="table">
                    <tr>
                        <th width="200">项目编号</th>
                        <td id="projectId"></td>
                    </tr>
                    <tr>
                        <th>最高限价</th>
                        <td id="maxPrice"></td>
                    </tr>
                </table>
            </div>
        </div>

        <!-- 投标信息表格 -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    投标信息列表
                    <div id="companyStats" class="mt-2" style="font-size: 0.9em;"></div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline-secondary active" id="sortByRatio">
                        <i class="bi bi-sort-numeric-down"></i> 按下浮率排序
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" id="sortByType">
                        <i class="bi bi-sort-alpha-down"></i> 按单位类型排序
                    </button>
                </div>
            </div>
            <div class="card-body">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>序号</th>
                            <th>投标单位</th>
                            <th>投标价格</th>
                            <th>下浮率</th>
                            <th>状态</th>
                        </tr>
                    </thead>
                    <tbody id="bidList">
                        <!-- 数据将通过JavaScript动态填充 -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 添加下浮率分布图 -->
        <div class="card mt-4">
            <div class="card-header">
                下浮率分布图
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="scatterChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.3.1/js/bootstrap.bundle.min.js"></script>
    <script>
        $(document).ready(function() {
            let sortedBids = [];
            let scatterChart = null;

            // 统一的颜色定义
            const colors = {
                '中标人': 'rgba(255, 165, 86, 0.8)', // 亮黄色
                '湖南省内': 'rgba(255, 99, 132, 0.6)',   // 红色
                '中字头': 'rgba(54, 162, 235, 0.6)',    // 蓝色
                '其他省外': 'rgba(75, 192, 192, 0.6)'   // 青色
            };

            // 统一的渲染函数
            // 添加样式
            const styleBlock = `
                <style>
                    .company-type-indicator {
                        display: inline-block;
                        width: 12px;
                        height: 12px;
                        border-radius: 2px;
                        margin-right: 8px;
                    }
                </style>
            `;
            $('head').append(styleBlock);

            // 修改渲染函数
            function renderBidList(bids) {
                const $bidList = $('#bidList');
                $bidList.empty();

                // 计算各类型单位数量
                const stats = {
                    '中标人': 0,                    
                    '湖南省内': 0,
                    '中字头': 0,
                    '其他省外': 0
                };

                bids.forEach((bid) => {
                    const type = getCompanyType(bid);
                    stats[type]++;
                    
                    const row = `
                        <tr>
                            <td>${bid.bid_id}</td>
                            <td>
                                <span class="company-type-indicator" style="background-color: ${colors[type]}"></span>
                                ${bid.bid_corp_name}
                                <a href="https://www.qcc.com/web/search?key=${encodeURIComponent(bid.bid_corp_name)}" 
                                   target="_blank" 
                                   class="company-link" 
                                   title="企业信息">
                                    <i class="bi bi-search"></i>
                                </a>
                                <!-- 阳光房图标 -->
                                <a href="http://yyjc.hnsdzjy.org:20005/sun/main?searchValue=${encodeURIComponent(bid.bid_corp_name)}&searchType=mainInfo" 
                                   target="_blank" 
                                   class="company-link" 
                                   title="阳光房信息">
                                    <i class="bi bi-sun"></i>
                                </a>
                                <!-- 公路图标 -->
                                <a href="https://hwdms.mot.gov.cn/BMWebSite/company/indexSearch.do?text=${encodeURIComponent(bid.bid_corp_name)}" 
                                   target="_blank" 
                                   class="company-link" 
                                   title="公路信息">
                                    <i class="bi bi-truck"></i>
                                </a>
                                <!-- 新增建筑图标 -->
                                <a href="https://jzsc.mohurd.gov.cn/data/company?complexname=${encodeURIComponent(bid.bid_corp_name)}" 
                                   target="_blank" 
                                   class="company-link" 
                                   title="建筑信息">
                                    <i class="bi bi-building"></i> <!-- 使用Bootstrap Icons中的建筑图标 -->
                                </a>
                            </td>
                            <td>${bid.bid_price.toLocaleString('zh-CN', {
                                style: 'currency',
                                currency: 'CNY'
                            })}</td>
                            <td>${(bid.bid_down_ratio * 100).toFixed(2)}%</td>
                            <td>${bid.bid_stat || '-'}</td>
                        </tr>
                    `;
                    $bidList.append(row);
                });

                // 渲染统计信息
                const statsHtml = Object.entries(stats)
                    .map(([type, count]) => `
                        <span class="me-3">
                            <span class="company-type-indicator" style="background-color: ${colors[type]}"></span>
                            ${type}：${count}
                        </span>
                    `)
                    .join('');
                
                $('#companyStats').html(statsHtml);
            }

            function getCompanyType(bid) {
                const companyName = bid.bid_corp_name;
                const bidStat = bid.bid_stat;
                const hunanCities = [
                    // 省会城市
                    '长沙', '芙蓉', '天心', '岳麓', '开福', '雨花', '望城', '长沙县', '浏阳', '宁乡',
                    // 株洲
                    '株洲', '荷塘', '芦淞', '石峰', '天元', '渌口', '攸县', '茶陵', '炎陵', '醴陵',
                    // 湘潭
                    '湘潭', '雨湖', '岳塘', '湘潭县', '湘乡', '韶山',
                    // 衡阳
                    '衡阳', '珠晖', '雁峰', '石鼓', '蒸湘', '南岳', '衡阳', '衡南', '衡山', '衡东', '祁东', '耒阳', '常宁',
                    // 邵阳
                    '邵阳', '双清', '大祥', '北塔', '邵东', '新邵', '邵阳', '隆回', '洞口', '绥宁', '新宁', '城步', '武冈',
                    // 岳阳
                    '岳阳', '岳阳楼', '云溪', '君山', '岳阳县', '华容', '湘阴', '平江', '汨罗', '临湘',
                    // 常德
                    '常德', '武陵', '鼎城', '安乡', '汉寿', '澧县', '临澧', '桃源', '石门', '津市',
                    // 张家界
                    '张家界', '永定', '武陵源', '慈利', '桑植',
                    // 益阳
                    '益阳', '资阳', '赫山', '南县', '桃江', '安化', '沅江',
                    // 郴州
                    '郴州', '北湖', '苏仙', '桂阳', '宜章', '永兴', '嘉禾', '临武', '汝城', '桂东', '安仁', '资兴',
                    // 永州
                    '永州', '零陵', '冷水滩', '祁阳', '东安', '双牌', '道县', '江永', '宁远', '蓝山', '新田', '江华',
                    // 怀化
                    '怀化', '鹤城', '中方', '沅陵', '辰溪', '溆浦', '会同', '麻阳', '新晃', '芷江', '靖州', '通道', '洪江',
                    // 娄底
                    '娄底', '娄星', '双峰', '新化', '冷水江', '涟源',
                    // 湘西土家族苗族自治州
                    '湘西', '吉首', '泸溪', '凤凰', '花垣', '保靖', '古丈', '永顺', '龙山'
                ];

                // 检查是否为中标人
                if (bidStat === '第一候选人' || bidStat === '中标单位') {
                    return '中标人';
                }

                // 检查是否为湖南省内单位
                if (companyName.includes('湖南') || 
                    hunanCities.some(city => companyName.includes(city))) {
                    return '湖南省内';
                }
                // 检查是否为中字头单位
                if (companyName.startsWith('中')) {
                    return '中字头';
                }
                // 其他省外单位
                return '其他省外';
            }

            function createScatterChart(bids, maxPrice) {
                const ctx = document.getElementById('scatterChart').getContext('2d');
                const companyDatasets = {};
                
                bids.forEach(bid => {
                    const type = getCompanyType(bid);
                
                    if (!companyDatasets[type]) {
                        companyDatasets[type] = {
                            label: type,
                            data: [],
                            backgroundColor: colors[type],  // 使用统一的颜色定义
                            pointRadius: 8,
                            pointHoverRadius: 10
                        };
                    }
                    companyDatasets[type].data.push({
                        x: Math.floor(bid.bid_down_ratio * 100),
                        y: (bid.bid_down_ratio * 100) % 1 * 100,
                        bid_corp_name: bid.bid_corp_name,
                        bid_down_ratio: bid.bid_down_ratio
                    });
                });
            
                if (scatterChart instanceof Chart) {
                    scatterChart.destroy();
                }
            
                scatterChart = new Chart(ctx, {
                    type: 'scatter',
                    data: {
                        datasets: Object.values(companyDatasets)
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: '下浮率整数部分 (%)'
                                },
                                ticks: {
                                    callback: value => `${value}%`
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: '下浮率小数部分 (%)'
                                },
                                ticks: {
                                    callback: value => `${value.toFixed(1)}%`
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        const point = context.raw;
                                        return [
                                            `单位: ${point.bid_corp_name}`,
                                            `下浮率: ${(point.bid_down_ratio * 100).toFixed(2)}%`
                                        ];
                                    }
                                }
                            },
                            legend: {
                                position: 'right',
                                labels: {
                                    boxWidth: 10
                                }
                            }
                        }
                    }
                });
            }

            // 获取URL参数中的project_id
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('project_id');

            if (!projectId) {
                alert('请提供项目ID！');
                return;
            }

            // 绑定按钮点击事件
            $('#analysisButton').click(function() {
                // 获取ajax返回的数据
                const maxPrice = $('#maxPrice').text().replace(/[^0-9.]/g, '');
                const bids = sortedBids.map(bid => bid.bid_price).join(',');
                const stats = sortedBids.map(bid => bid.bid_stat || '').join(',');

                // 构建跳转URL
                const url = `https://pages.liubeijs.com/cal65.html?maxPrice=${maxPrice}&bids=${bids}&stats=${encodeURIComponent(stats)}`;
                
                // 跳转到新页面
                window.open(url, '_blank');
            });

            // 统一的数据加载函数
            function loadProjectData() {
                // 添加加载状态提示
                $('#projectTitle').html('<div class="spinner-border spinner-border-sm me-2" role="status"></div>项目信息加载中...');
                
                $.ajax({
                    url: `https://sf.liubeijs.com/api/project/${projectId}`,
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    success: function(response) {
                        const project = response.data[0];
                        
                        // 更新项目基本信息
                        $('#projectTitle').text(project.project_name);
                        $('#projectId').text(project.project_id);
                        $('#maxPrice').text(project.project_max_price.toLocaleString('zh-CN', {
                            style: 'currency',
                            currency: 'CNY'
                        }));

                        // 对投标数据按下浮率排序（从高到低）
                        sortedBids = project.project_bids
                            .filter(bid => bid.bid_price !== null)
                            .sort((a, b) => b.bid_down_ratio - a.bid_down_ratio);

                        renderBidList(sortedBids);
                        createScatterChart(sortedBids, project.project_max_price);
                    },
                    error: function(xhr, status, error) {
                        let errorMessage = '加载失败';
                        if (xhr.status === 403) {
                            errorMessage = '访问被拒绝，请检查访问权限';
                        } else if (xhr.status === 0) {
                            errorMessage = '无法连接到服务器，请检查网络连接';
                        }
                        
                        $('#projectTitle').html(`
                            <div class="text-danger">
                                <i class="bi bi-exclamation-triangle me-2"></i>${errorMessage}
                            </div>
                        `);
                        console.error('加载数据失败：', {status: xhr.status, error: error});
                    }
                });
            }

            // 修改排序事件处理
            $('#sortByType').click(function() {
                $(this).addClass('active').siblings().removeClass('active');
                sortedBids.sort((a, b) => {
                    const typeA = getCompanyType(a);
                    const typeB = getCompanyType(b);
                
                    // 将“中标人”类型放在第一位
                    if (typeA === '中标人') return -1;
                    if (typeB === '中标人') return 1;
                
                    return typeA.localeCompare(typeB);
                });
                renderBidList(sortedBids);
                createScatterChart(sortedBids);
            });

            $('#sortByRatio').click(function() {
                $(this).addClass('active').siblings().removeClass('active');
                sortedBids.sort((a, b) => b.bid_down_ratio - a.bid_down_ratio);
                renderBidList(sortedBids);
                createScatterChart(sortedBids);
            });
            $('thead th:nth-child(2)').html('投标单位');
            
            // 初始加载数据
            loadProjectData();
        });
        // 绑定省中心阳光房按钮点击事件
        $('#sunshineRoomButton').click(function() {
            const projectName = $('#projectTitle').text().substring(0, 20); // 获取项目名字的前20个字符
            const url = `http://yyjc.hnsdzjy.org:20005/sun/project?searchValue=${encodeURIComponent(projectName)}&searchType=projectInfo`;
            window.open(url, '_blank');
        });
    </script>
</body>
</html>