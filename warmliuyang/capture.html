<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="description" content="éšæ‰‹æ‹ - æ¸©æš–æµé˜³">
    <meta name="keywords" content="éšæ‰‹æ‹,ä¸ŠæŠ¥,æµé˜³,åŸå¸‚ç®¡ç†">
    <title>éšæ‰‹æ‹ - æ¸©æš–æµé˜³</title>
    
    <!-- PWAæ”¯æŒ -->
    <meta name="theme-color" content="#E55C27">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="éšæ‰‹æ‹">
    
    <!-- å­—ä½“ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- æ ·å¼æ–‡ä»¶ -->
    <link rel="stylesheet" href="capture.css">
    
    <!-- JavaScriptæ–‡ä»¶ -->
    <script src="capture.js"></script>
</head>
<body>
    <div class="capture-page">
        <!-- å¤´éƒ¨ -->
        <div class="capture-header">
            <button class="capture-back-btn" id="captureBackBtn">
                <span class="back-icon">â€¹</span>
            </button>
            <div class="capture-title">éšæ‰‹æ‹</div>
            <div class="capture-placeholder"></div>
        </div>
        
        <!-- å†…å®¹åŒºåŸŸ -->
        <div class="capture-content">
            <!-- åª’ä½“ä¸Šä¼ åŒºåŸŸ -->
            <div class="media-upload-section">
                <div class="section-title">ä¸Šä¼ å›¾ç‰‡æˆ–è§†é¢‘ (æœ€å¤š3ä¸ª)</div>
                <div class="media-upload-grid">
                    <div class="media-upload-item" id="mediaUpload1">
                        <div class="upload-placeholder">
                            <div class="upload-icon">ğŸ“·</div>
                            <div class="upload-text">ç‚¹å‡»ä¸Šä¼ </div>
                        </div>
                    </div>
                    <div class="media-upload-item" id="mediaUpload2">
                        <div class="upload-placeholder">
                            <div class="upload-icon">ğŸ“·</div>
                            <div class="upload-text">ç‚¹å‡»ä¸Šä¼ </div>
                        </div>
                    </div>
                    <div class="media-upload-item" id="mediaUpload3">
                        <div class="upload-placeholder">
                            <div class="upload-icon">ğŸ“·</div>
                            <div class="upload-text">ç‚¹å‡»ä¸Šä¼ </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ä½ç½®ä¿¡æ¯åŒºåŸŸ -->
            <div class="location-section">
                <div class="section-title">äº‹å‘ä½ç½®</div>
                <div class="location-input-group">
                    <div class="location-icon">ğŸ“</div>
                    <input type="text" class="location-input" id="locationInput" placeholder="æ­£åœ¨è·å–ä½ç½®..." readonly>
                    <button class="location-edit-btn" id="locationEditBtn">ç¼–è¾‘</button>
                </div>
                <div class="location-tips">ç³»ç»Ÿå·²è‡ªåŠ¨è¯†åˆ«æ‚¨çš„å½“å‰ä½ç½®</div>
            </div>
            
            <!-- äº‹ä»¶åˆ†ç±»åŒºåŸŸ -->
            <div class="category-section">
                <div class="section-title">äº‹ä»¶åˆ†ç±»</div>
                <div class="current-category">
                    <div class="category-display" id="currentCategory">
                        <div class="category-icon">ğŸ…¿ï¸</div>
                        <div class="category-text">è¿ç« å é“</div>
                    </div>
                    <button class="category-select-btn" id="categorySelectBtn">é€‰æ‹©</button>
                </div>
                <div class="category-tips">ç³»ç»Ÿå·²æ™ºèƒ½è¯†åˆ«äº‹ä»¶ç±»å‹ï¼Œæ‚¨å¯ä»¥æ‰‹åŠ¨è°ƒæ•´</div>
            </div>
            
            <!-- æè¿°åŒºåŸŸ -->
            <div class="description-section">
                <div class="section-title">é—®é¢˜æè¿° (å¯é€‰)</div>
                <textarea class="description-input" id="descriptionInput" placeholder="è¯·è¯¦ç»†æè¿°å‘ç°çš„é—®é¢˜..."></textarea>
            </div>
        </div>
        
        <!-- åº•éƒ¨æ“ä½œåŒºåŸŸ -->
        <div class="capture-footer">
            <button class="submit-btn" id="submitReportBtn">
                <span class="submit-icon">ğŸ“¤</span>
                <span class="submit-text">ä¸€é”®ä¸ŠæŠ¥</span>
            </button>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // éšæ‰‹æ‹é¡µé¢çš„JavaScriptåŠŸèƒ½
        class CaptureApp {
            constructor() {
                this.selectedCategory = 'è¿ç« å é“';
                this.uploadedMedia = [];
                this.currentLocation = '';
                this.init();
            }

            init() {
                this.bindEvents();
                this.getCurrentLocation();
                this.initCategorySelection();
                this.initMediaUpload();
            }

            bindEvents() {
                // è¿”å›æŒ‰é’®
                const backBtn = document.getElementById('captureBackBtn');
                if (backBtn) {
                    backBtn.addEventListener('click', () => {
                        window.history.back();
                    });
                }

                // æäº¤æŒ‰é’®
                const submitBtn = document.getElementById('submitReportBtn');
                if (submitBtn) {
                    submitBtn.addEventListener('click', () => {
                        this.submitReport();
                    });
                }

                // ä½ç½®ç¼–è¾‘æŒ‰é’®
                const locationEditBtn = document.getElementById('locationEditBtn');
                if (locationEditBtn) {
                    locationEditBtn.addEventListener('click', () => {
                        this.editLocation();
                    });
                }
            }

            getCurrentLocation() {
                const locationInput = document.getElementById('locationInput');
                if (!locationInput) return;

                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const { latitude, longitude } = position.coords;
                            // è¿™é‡Œåº”è¯¥è°ƒç”¨åœ°ç†ç¼–ç APIè·å–åœ°å€
                            // æš‚æ—¶ä½¿ç”¨æ¨¡æ‹Ÿåœ°å€
                            this.currentLocation = `æµé˜³å¸‚æ·®å·è¡—é“åŠäº‹å¤„ (${latitude.toFixed(4)}, ${longitude.toFixed(4)})`;
                            locationInput.value = this.currentLocation;
                            locationInput.placeholder = '';
                        },
                        (error) => {
                            console.error('è·å–ä½ç½®å¤±è´¥:', error);
                            this.currentLocation = 'æµé˜³å¸‚æ·®å·è¡—é“åŠäº‹å¤„';
                            locationInput.value = this.currentLocation;
                            locationInput.placeholder = '';
                        }
                    );
                } else {
                    this.currentLocation = 'æµé˜³å¸‚æ·®å·è¡—é“åŠäº‹å¤„';
                    locationInput.value = this.currentLocation;
                    locationInput.placeholder = '';
                }
            }

            initCategorySelection() {
                const categoryItems = document.querySelectorAll('.category-item');
                categoryItems.forEach(item => {
                    item.addEventListener('click', () => {
                        // ç§»é™¤æ‰€æœ‰activeç±»
                        categoryItems.forEach(i => i.classList.remove('active'));
                        // æ·»åŠ activeç±»åˆ°å½“å‰é¡¹
                        item.classList.add('active');
                        this.selectedCategory = item.dataset.category;
                    });
                });
            }

            initMediaUpload() {
                for (let i = 1; i <= 3; i++) {
                    const uploadItem = document.getElementById(`mediaUpload${i}`);
                    if (uploadItem) {
                        uploadItem.addEventListener('click', () => {
                            this.selectMedia(i);
                        });
                    }
                }
            }

            selectMedia(index) {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*,video/*';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        this.handleMediaUpload(file, index);
                    }
                };
                input.click();
            }

            handleMediaUpload(file, index) {
                const uploadItem = document.getElementById(`mediaUpload${index}`);
                if (!uploadItem) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const mediaUrl = e.target.result;
                    
                    // åˆ›å»ºé¢„è§ˆå…ƒç´ 
                    const preview = document.createElement('div');
                    preview.style.cssText = `
                        width: 100%;
                        height: 100%;
                        position: relative;
                        border-radius: 10px;
                        overflow: hidden;
                    `;

                    if (file.type.startsWith('image/')) {
                        const img = document.createElement('img');
                        img.src = mediaUrl;
                        img.style.cssText = `
                            width: 100%;
                            height: 100%;
                            object-fit: cover;
                        `;
                        preview.appendChild(img);
                    } else if (file.type.startsWith('video/')) {
                        const video = document.createElement('video');
                        video.src = mediaUrl;
                        video.style.cssText = `
                            width: 100%;
                            height: 100%;
                            object-fit: cover;
                        `;
                        preview.appendChild(video);
                    }

                    // æ·»åŠ åˆ é™¤æŒ‰é’®
                    const removeBtn = document.createElement('button');
                    removeBtn.innerHTML = 'Ã—';
                    removeBtn.style.cssText = `
                        position: absolute;
                        top: 4px;
                        right: 4px;
                        width: 20px;
                        height: 20px;
                        background: rgba(0, 0, 0, 0.6);
                        border: none;
                        border-radius: 50%;
                        color: white;
                        font-size: 12px;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    `;
                    removeBtn.onclick = (e) => {
                        e.stopPropagation();
                        this.removeMedia(index);
                    };
                    preview.appendChild(removeBtn);

                    // æ›¿æ¢ä¸Šä¼ åŒºåŸŸå†…å®¹
                    uploadItem.innerHTML = '';
                    uploadItem.appendChild(preview);
                    uploadItem.classList.add('has-media');

                    // ä¿å­˜æ–‡ä»¶ä¿¡æ¯
                    this.uploadedMedia[index - 1] = {
                        file: file,
                        url: mediaUrl,
                        type: file.type
                    };
                };
                reader.readAsDataURL(file);
            }

            removeMedia(index) {
                const uploadItem = document.getElementById(`mediaUpload${index}`);
                if (!uploadItem) return;

                // æ¢å¤åŸå§‹ä¸Šä¼ ç•Œé¢
                uploadItem.innerHTML = `
                    <div class="upload-placeholder">
                        <div class="upload-icon">ğŸ“·</div>
                        <div class="upload-text">ç‚¹å‡»ä¸Šä¼ </div>
                    </div>
                `;
                uploadItem.classList.remove('has-media');

                // æ¸…é™¤æ–‡ä»¶ä¿¡æ¯
                this.uploadedMedia[index - 1] = null;
            }

            editLocation() {
                const locationInput = document.getElementById('locationInput');
                if (!locationInput) return;

                const newLocation = prompt('è¯·è¾“å…¥æ–°çš„ä½ç½®ä¿¡æ¯:', this.currentLocation);
                if (newLocation && newLocation.trim()) {
                    this.currentLocation = newLocation.trim();
                    locationInput.value = this.currentLocation;
                }
            }

            submitReport() {
                const description = document.getElementById('descriptionInput')?.value || '';
                
                // éªŒè¯å¿…å¡«é¡¹
                if (this.uploadedMedia.filter(media => media).length === 0) {
                    alert('è¯·è‡³å°‘ä¸Šä¼ ä¸€å¼ å›¾ç‰‡æˆ–è§†é¢‘');
                    return;
                }

                if (!this.currentLocation) {
                    alert('è¯·ç¡®è®¤äº‹å‘ä½ç½®');
                    return;
                }

                // æ„å»ºä¸ŠæŠ¥æ•°æ®
                const reportData = {
                    category: this.selectedCategory,
                    location: this.currentLocation,
                    description: description,
                    media: this.uploadedMedia.filter(media => media),
                    timestamp: new Date().toISOString()
                };

                console.log('ä¸ŠæŠ¥æ•°æ®:', reportData);

                // æ˜¾ç¤ºæäº¤æˆåŠŸ
                alert('ä¸ŠæŠ¥æˆåŠŸï¼æ„Ÿè°¢æ‚¨çš„å‚ä¸ï¼Œæˆ‘ä»¬ä¼šå°½å¿«å¤„ç†ã€‚');
                
                // è¿”å›é¦–é¡µ
                window.location.href = 'index.html';
            }
        }

        // åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', () => {
            // æ³¨é‡Šæ‰åŸæœ‰çš„CaptureAppç±»åˆå§‹åŒ–ï¼Œä½¿ç”¨capture.jsä¸­çš„åˆå§‹åŒ–
            // new CaptureApp();
        });
    </script>
</body>
</html>